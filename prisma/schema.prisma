// Prisma schema for TENKU demo
// Update DATABASE_URL in your environment to point to your database.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DocumentType {
  JOB_OFFER_PDF
  OTHER
}

enum JobStatus {
  OPEN
  CLOSED
}

enum TaskStatus {
  TODO
  DOING
  DONE
}

enum OrganizationType {
  SUPPORT
  SENDING
  SUPERVISING
  TRAINING
}

enum TravelType {
  FLIGHT
  BUS
}

enum TripStatus {
  DRAFT
  PREP
  READY
  OUTBOUND
  RETURNED
}

enum CaseProgram {
  ALL
  TITP
  SSW
  TA
}

model Company {
  id             String         @id @default(cuid())
  tenantId       String
  name           String
  address        String?
  industry       String?
  contactName    String?
  contactTel     String?
  defaultOrgId   String?
  defaultOrgType String?
  metaJson       Json?          @map("meta_json")
  tenant         Tenant         @relation(fields: [tenantId], references: [id])
  jobs           Job[]
  persons        Person[]
  cases          Case[]
  tasks          Task[]
  applications   Application[]
  trainingPlans  TrainingPlan[]
  monitoringLogs MonitoringLog[]
  engagements    Engagement[]
  supportPlans   SupportPlan[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model Job {
  id                  String     @id @default(cuid())
  tenantId            String     @map("tenant_id")
  companyId           String     @map("company_id")
  title               String     @map("job_title")
  workLocation        String?    @map("work_location")
  salary              String?
  notes               String?
  occupation          String?
  description         String?    @map("job_description")
  benefits            String?
  employmentType      String?    @map("employment_type")
  requirements        String?
  applicationDeadline DateTime?  @map("application_deadline")
  jobOfferVersion     Int        @default(0) @map("job_offer_version")
  latestJobOfferDocId String?    @map("latest_job_offer_doc_id")
  status              JobStatus
  metaJson            Json?      @map("meta_json")
  company             Company    @relation(fields: [companyId], references: [id])
  tenant              Tenant     @relation(fields: [tenantId], references: [id])
  documents           Document[]
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")
}

model Tenant {
  id                    String                @id @default(cuid())
  name                  String
  code                  String                @unique
  persons               Person[]
  companies             Company[]
  cases                 Case[]
  tasks                 Task[]
  alerts                Alert[]
  organizations         Organization[]
  personStatusHistories PersonStatusHistory[]
  applications          Application[]
  trainingPlans         TrainingPlan[]
  jobs                  Job[]
  travelPlans           TravelPlan[]
  engagements           Engagement[]
  supportPlans          SupportPlan[]
  educationCourses      EducationCourse[]
  translationJobs       TranslationJob[]
}

model Organization {
  id            String         @id @default(cuid())
  tenantId      String
  orgType       OrganizationType
  displayName   String
  tenant        Tenant         @relation(fields: [tenantId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  trainingPlans TrainingPlan[]
  monitoringLogs MonitoringLog[] @relation("SupervisorOrg")
  sendingPersons Person[]        @relation("SendingOrg")
}

model Person {
  id                  String                @id @default(cuid())
  tenantId            String
  foreignerId         String?
  nickname            String?
  nameKanji           String?
  nameKana            String?
  nameRoma            String?
  gender              String?
  displayLanguage     String?
  residenceCardNumber String?
  residenceStart      DateTime?
  dormAddress         String?
  arrivalDate         DateTime?
  assignmentDate      DateTime?
  employmentContractPeriod String?
  sendingOrgId        String?
  certNumber1         String?
  certDate1           DateTime?
  certNumber2         String?
  certDate2           DateTime?
  certNumber3         String?
  certDate3           DateTime?
  changeCertNumber    String?
  changeCertDate      DateTime?
  traineeNoticeNumber String?
  traineeNoticeDate   DateTime?
  handlerName         String?
  nextProcedure       String?
  notes               String?
  fullName            String
  nationality         String?
  nativeLanguage      String?
  birthDate           DateTime?
  currentCompanyId    String?
  currentProgram      String?
  residenceCardExpiry DateTime?             @map("residence_card_expiry")
  passportExpiry      DateTime?             @map("passport_expiry")
  metaJson            Json?
  tenant              Tenant                @relation(fields: [tenantId], references: [id])
  currentCompany      Company?              @relation(fields: [currentCompanyId], references: [id])
  sendingOrg          Organization?         @relation("SendingOrg", fields: [sendingOrgId], references: [id])
  cases                 Case[]
  tasks                 Task[]
  statusHistory         PersonStatusHistory[]
  applications          Application[]
  trainingPlans         TrainingPlan[]
  monitoringLogs        MonitoringLog[]
  travelPlans           TravelPlan[]
  engagements           Engagement[]
  supportPlans          SupportPlan[]
  educationSubmissions  EducationSubmission[]
  translationJobs       TranslationJob[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
}

model PersonStatusHistory {
  id              String    @id @default(cuid())
  tenantId        String
  personId        String
  program         String
  residenceStatus String?
  startDate       DateTime
  endDate         DateTime?
  metaJson        Json?
  person          Person    @relation(fields: [personId], references: [id])
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  createdAt       DateTime  @default(now())
}

model Case {
  id           String        @id @default(cuid())
  tenantId     String        @map("tenant_id")
  program      CaseProgram
  caseType     String        @map("case_type")
  status       String
  personId     String?       @map("person_id")
  companyId    String?       @map("company_id")
  ownerOrgId   String?       @map("owner_org_id")
  dueDate      DateTime?     @map("due_date")
  metaJson     Json?         @map("meta_json")
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  person       Person?       @relation(fields: [personId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])
  tasks        Task[]
  applications Application[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Task {
  id           String     @id @default(cuid())
  tenantId     String     @map("tenant_id")
  caseId       String?    @map("case_id")
  personId     String?
  companyId    String?
  title        String?
  taskType     String
  status       TaskStatus
  metaJson     Json?      @map("meta_json")
  dueDate      DateTime?  @map("due_date")
  createdBy    String?
  ruleSnapshot Json?
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  case         Case?      @relation(fields: [caseId], references: [id])
  person       Person?    @relation(fields: [personId], references: [id])
  company      Company?   @relation(fields: [companyId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Alert {
  id         String   @id @default(cuid())
  tenantId   String
  alertType  String
  severity   String
  targetType String
  targetId   String
  status     String
  threshold  String?
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Application {
  id              String    @id @default(cuid())
  tenantId        String
  personId        String?
  companyId       String?
  caseId          String?
  applicationType String
  status          String    @default("DRAFT")
  submittedAt     DateTime?
  documentUrl     String?
  metadata        Json?
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  person          Person?   @relation(fields: [personId], references: [id])
  company         Company?  @relation(fields: [companyId], references: [id])
  case            Case?     @relation(fields: [caseId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model TrainingPlan {
  id           String        @id @default(cuid())
  tenantId     String
  personId     String?
  companyId    String?
  orgId        String?
  planType     String
  status       String        @default("DRAFT")
  plannedStart DateTime?
  plannedEnd   DateTime?
  documentUrl  String?
  metadata     Json?
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  person       Person?       @relation(fields: [personId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])
  organization Organization? @relation(fields: [orgId], references: [id])
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model Document {
  id          String       @id @default(cuid())
  tenantId    String
  createdById String
  docType     DocumentType
  url         String
  version     Int          @default(1)
  jobId       String?
  job         Job?         @relation(fields: [jobId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model MonitoringLog {
  id           String        @id @default(cuid())
  tenantId     String
  date         DateTime
  personId     String?
  companyId    String?
  supervisorId String?
  logType      String
  overtimeHours Int?
  memo         String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  person       Person?       @relation(fields: [personId], references: [id])
  company      Company?      @relation(fields: [companyId], references: [id])
  supervisor   Organization? @relation("SupervisorOrg", fields: [supervisorId], references: [id])
}

model MinorChangeNotice {
  id           String   @id @default(cuid())
  tenantId     String
  month        DateTime
  companyId    String
  supervisorId String
  details      Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ─── 移動・渡航管理 ───────────────────────────────────────────────────────────

model TravelPlan {
  id           String     @id @default(cuid())
  tenantId     String     @map("tenant_id")
  personId     String     @map("person_id")
  tripGroupId  String?    @map("trip_group_id")
  travelType   TravelType @map("travel_type")
  provider     String?
  bookingUrl   String?    @map("booking_url")
  tripStatus   TripStatus @default(DRAFT) @map("trip_status")
  departureDate DateTime? @map("departure_date")
  returnDate   DateTime?  @map("return_date")
  notes        String?
  metaJson     Json?      @map("meta_json")
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  person       Person     @relation(fields: [personId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// ─── エンゲージメント（誰が・どの会社に・どの制度で）────────────────────────────

model Engagement {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  personId  String    @map("person_id")
  companyId String    @map("company_id")
  orgId     String?   @map("org_id")
  program   String    // TITP / SSW / TA
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")
  status    String    @default("ACTIVE")
  metaJson  Json?     @map("meta_json")
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  person    Person    @relation(fields: [personId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ─── 支援計画・面談・記録（特定技能）──────────────────────────────────────────

model SupportPlan {
  id            String    @id @default(cuid())
  tenantId      String    @map("tenant_id")
  personId      String?   @map("person_id")
  companyId     String?   @map("company_id")
  orgId         String?   @map("org_id")
  planType      String    @map("plan_type")
  status        String    @default("DRAFT")
  scheduledDate DateTime? @map("scheduled_date")
  conductedDate DateTime? @map("conducted_date")
  documentUrl   String?   @map("document_url")
  memo          String?
  metaJson      Json?     @map("meta_json")
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  person        Person?   @relation(fields: [personId], references: [id])
  company       Company?  @relation(fields: [companyId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ─── 教育（Google Classroom連携）────────────────────────────────────────────

model EducationCourse {
  id                String                @id @default(cuid())
  tenantId          String                @map("tenant_id")
  classroomCourseId String?               @map("classroom_course_id")
  name              String
  section           String?
  syncedAt          DateTime?             @map("synced_at")
  metaJson          Json?                 @map("meta_json")
  tenant            Tenant                @relation(fields: [tenantId], references: [id])
  submissions       EducationSubmission[]
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}

model EducationSubmission {
  id              String          @id @default(cuid())
  tenantId        String          @map("tenant_id")
  courseId        String          @map("course_id")
  personId        String?         @map("person_id")
  courseWorkId    String?         @map("course_work_id")
  courseWorkTitle String?         @map("course_work_title")
  submittedAt     DateTime?       @map("submitted_at")
  dueDate         DateTime?       @map("due_date")
  score           Float?
  maxScore        Float?          @map("max_score")
  state           String?
  audioUrl        String?         @map("audio_url")
  metaJson        Json?           @map("meta_json")
  course          EducationCourse @relation(fields: [courseId], references: [id])
  person          Person?         @relation(fields: [personId], references: [id])
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// ─── 翻訳ジョブ ──────────────────────────────────────────────────────────────

model TranslationJob {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  personId       String?  @map("person_id")
  sourceLanguage String   @default("ja") @map("source_language")
  targetLanguage String   @map("target_language")
  contentType    String   @map("content_type")
  status         String   @default("PENDING")
  sourceUrl      String?  @map("source_url")
  resultUrl      String?  @map("result_url")
  notes          String?
  metaJson       Json?    @map("meta_json")
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  person         Person?  @relation(fields: [personId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
